-- ------------------------------------------------------------------------------------------------
-- 1. TABLES
--
-- Definisikan semua tabel sebagai fondasi awal.
-- ------------------------------------------------------------------------------------------------

-- Tabel untuk menyimpan data profil pengguna, diperluas dari auth.users
CREATE TABLE
  public.profiles (
    id uuid NOT NULL PRIMARY KEY REFERENCES auth.users (id) ON DELETE CASCADE,
    updated_at timestamp with time zone NULL,
    name character varying NULL,
    id_pjlp character varying NULL UNIQUE,
    phone character varying NULL,
    avatar_url character varying NULL,
    email character varying NULL UNIQUE,
    role character varying NULL DEFAULT 'anggota'::character varying
  );

-- Tabel untuk menyimpan catatan saldo cuti tahunan per pengguna
CREATE TABLE
  public.leave_balances (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id uuid NOT NULL REFERENCES public.profiles (id) ON DELETE CASCADE,
    year smallint NOT NULL,
    total_days smallint NOT NULL DEFAULT 12,
    used_days smallint NOT NULL DEFAULT 0,
    UNIQUE (user_id, year)
  );

-- Tabel untuk menyimpan semua pengajuan cuti
CREATE TABLE
  public.leave_requests (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id uuid NOT NULL REFERENCES public.profiles (id) ON DELETE CASCADE,
    created_at timestamp with time zone NOT NULL DEFAULT now(),
    updated_at timestamp with time zone NOT NULL DEFAULT now(),
    title character varying NOT NULL,
    reason text NULL,
    start_date date NOT NULL,
    end_date date NOT NULL,
    duration smallint NOT NULL,
    status character varying NOT NULL DEFAULT 'Menunggu'::character varying,
    attachment_url character varying NULL,
    is_read_by_user boolean NOT NULL DEFAULT FALSE
  );

-- Tabel untuk notifikasi yang ditujukan kepada admin
CREATE TABLE
  public.notifications (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id uuid NOT NULL REFERENCES public.profiles (id) ON DELETE CASCADE, -- User yang dituju (dalam kasus ini, admin)
    created_at timestamp with time zone NOT NULL DEFAULT now(),
    message text NOT NULL,
    leave_request_id bigint NOT NULL REFERENCES public.leave_requests (id) ON DELETE CASCADE,
    is_read boolean NOT NULL DEFAULT FALSE
  );

-- ------------------------------------------------------------------------------------------------
-- 2. INDEXES
--
-- Tambahkan indeks untuk mempercepat query pada kolom yang sering digunakan untuk filter atau join.
-- ------------------------------------------------------------------------------------------------
CREATE INDEX ix_profiles_role ON public.profiles USING btree (role);
CREATE INDEX ix_leave_balances_user_id_year ON public.leave_balances USING btree (user_id, year);
CREATE INDEX ix_leave_requests_user_id ON public.leave_requests USING btree (user_id);
CREATE INDEX ix_leave_requests_status ON public.leave_requests USING btree (status);
CREATE INDEX ix_notifications_user_id ON public.notifications USING btree (user_id);


-- ------------------------------------------------------------------------------------------------
-- 3. FUNCTIONS
--
-- Definisikan fungsi-fungsi helper yang akan digunakan oleh RLS Policies dan Triggers.
-- ------------------------------------------------------------------------------------------------

-- Fungsi untuk mendapatkan peran pengguna saat ini (current user)
CREATE OR REPLACE FUNCTION public.get_user_role()
RETURNS text
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
BEGIN
  IF auth.uid() IS NULL THEN
    RETURN 'anon';
  ELSE
    RETURN (SELECT role FROM public.profiles WHERE id = auth.uid());
  END IF;
END;
$$;

-- Fungsi yang akan dipanggil oleh trigger saat ada user baru di auth.users
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS trigger
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
BEGIN
  -- Sisipkan data dari auth.users ke public.profiles
  INSERT INTO public.profiles (id, name, id_pjlp, phone, email, role)
  VALUES (
    NEW.id,
    NEW.raw_user_meta_data->>'name',
    NEW.raw_user_meta_data->>'id_pjlp',
    NEW.raw_user_meta_data->>'phone',
    NEW.email,
    'anggota' -- Default role untuk semua pendaftar baru
  );
  RETURN NEW;
END;
$$;

-- Fungsi yang akan dipanggil oleh trigger saat profil baru dibuat
CREATE OR REPLACE FUNCTION public.handle_new_profile()
RETURNS trigger
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
BEGIN
    -- Buat entri saldo cuti untuk tahun saat ini
    INSERT INTO public.leave_balances (user_id, year, total_days, used_days)
    VALUES (NEW.id, EXTRACT(YEAR FROM NOW()), 12, 0);
    RETURN NEW;
END;
$$;


-- Fungsi untuk membuat notifikasi kepada semua admin saat ada pengajuan cuti baru
CREATE OR REPLACE FUNCTION public.create_admin_notification_for_new_leave()
RETURNS trigger
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
  admin_record RECORD;
  requesting_user_name TEXT;
BEGIN
  -- Ambil nama pengguna yang mengajukan cuti
  SELECT name INTO requesting_user_name FROM public.profiles WHERE id = NEW.user_id;

  -- Loop melalui semua admin dan buat notifikasi untuk mereka
  FOR admin_record IN SELECT id FROM public.profiles WHERE role = 'admin' LOOP
    INSERT INTO public.notifications (user_id, message, leave_request_id)
    VALUES (
      admin_record.id,
      requesting_user_name || ' telah mengajukan cuti baru: "' || NEW.title || '".',
      NEW.id
    );
  END LOOP;
  RETURN NEW;
END;
$$;


-- Fungsi untuk reset saldo cuti tahunan, dijalankan via Cron Job
CREATE OR REPLACE FUNCTION public.handle_new_year_leave_balances()
RETURNS void
LANGUAGE plpgsql
AS $$
DECLARE
  user_record RECORD;
  current_year SMALLINT;
BEGIN
  current_year := EXTRACT(YEAR FROM NOW());
  -- Loop melalui semua anggota aktif
  FOR user_record IN SELECT id FROM public.profiles WHERE role = 'anggota' LOOP
    -- Masukkan saldo cuti baru untuk tahun ini, abaikan jika sudah ada
    INSERT INTO public.leave_balances (user_id, year, total_days, used_days)
    VALUES (user_record.id, current_year, 12, 0)
    ON CONFLICT (user_id, year) DO NOTHING;
  END LOOP;
END;
$$;


-- ------------------------------------------------------------------------------------------------
-- 4. ROW LEVEL SECURITY (RLS)
--
-- Aktifkan RLS dan definisikan kebijakan untuk setiap tabel.
-- ------------------------------------------------------------------------------------------------

-- Aktifkan RLS untuk semua tabel
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.leave_balances ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.leave_requests ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.notifications ENABLE ROW LEVEL SECURITY;

-- Kebijakan untuk tabel `profiles`
CREATE POLICY "Allow authenticated users to read their own profile" ON public.profiles FOR SELECT USING (auth.uid() = id);
CREATE POLICY "Allow users to update their own profile" ON public.profiles FOR UPDATE USING (auth.uid() = id);
CREATE POLICY "Allow admin to view all profiles" ON public.profiles FOR SELECT TO authenticated USING (get_user_role() = 'admin');
CREATE POLICY "Allow admin to update any profile" ON public.profiles FOR UPDATE TO authenticated USING (get_user_role() = 'admin') WITH CHECK (get_user_role() = 'admin');
CREATE POLICY "Allow admin to delete any profile" ON public.profiles FOR DELETE TO authenticated USING (get_user_role() = 'admin');


-- Kebijakan untuk tabel `leave_balances`
CREATE POLICY "Allow users to read their own leave balances" ON public.leave_balances FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Allow admin to read all leave balances" ON public.leave_balances FOR SELECT TO authenticated USING (get_user_role() = 'admin');
CREATE POLICY "Allow admin to update all leave balances" ON public.leave_balances FOR UPDATE TO authenticated USING (get_user_role() = 'admin') WITH CHECK (get_user_role() = 'admin');


-- Kebijakan untuk tabel `leave_requests`
CREATE POLICY "Allow users to create their own leave requests" ON public.leave_requests FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Allow users to read their own leave requests" ON public.leave_requests FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Allow users to update their own read status" ON public.leave_requests FOR UPDATE USING (auth.uid() = user_id) WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Allow admin to read all leave requests" ON public.leave_requests FOR SELECT TO authenticated USING (get_user_role() = 'admin');
CREATE POLICY "Allow admin to update any leave request" ON public.leave_requests FOR UPDATE TO authenticated USING (get_user_role() = 'admin') WITH CHECK (get_user_role() = 'admin');

-- Kebijakan untuk tabel `notifications`
CREATE POLICY "Allow admin to read their own notifications" ON public.notifications FOR SELECT TO authenticated USING (auth.uid() = user_id AND get_user_role() = 'admin');
CREATE POLICY "Allow admin to update their own notifications" ON public.notifications FOR UPDATE TO authenticated USING (auth.uid() = user_id AND get_user_role() = 'admin') WITH CHECK (auth.uid() = user_id AND get_user_role() = 'admin');

-- ------------------------------------------------------------------------------------------------
-- 5. TRIGGERS
--
-- Buat pemicu (triggers) untuk mengotomatiskan proses.
-- ------------------------------------------------------------------------------------------------

-- Trigger untuk membuat profil saat user baru terdaftar di Supabase Auth
CREATE TRIGGER on_auth_user_created
AFTER INSERT ON auth.users
FOR EACH ROW
EXECUTE FUNCTION public.handle_new_user();

-- Trigger untuk membuat saldo cuti saat profil baru dibuat
CREATE TRIGGER on_profile_created_for_new_user
AFTER INSERT ON public.profiles
FOR EACH ROW
EXECUTE FUNCTION public.handle_new_profile();

-- Trigger untuk membuat notifikasi admin saat ada pengajuan cuti baru
CREATE TRIGGER on_leave_request_inserted
AFTER INSERT ON public.leave_requests
FOR EACH ROW
EXECUTE FUNCTION public.create_admin_notification_for_new_leave();


-- ------------------------------------------------------------------------------------------------
-- 6. STORAGE
--
-- Konfigurasi penyimpanan file.
-- ------------------------------------------------------------------------------------------------

-- Buat bucket untuk lampiran cuti
INSERT INTO storage.buckets (id, name, public, file_size_limit, allowed_mime_types)
VALUES ('lampiran-cuti', 'lampiran-cuti', TRUE, 5242880, ARRAY['image/jpeg', 'image/png', 'application/pdf'])
ON CONFLICT (id) DO NOTHING;

-- Kebijakan untuk storage bucket 'lampiran-cuti'
CREATE POLICY "Allow public read access to attachments" ON storage.objects FOR SELECT USING (bucket_id = 'lampiran-cuti');
CREATE POLICY "Allow authenticated users to upload attachments" ON storage.objects FOR INSERT TO authenticated WITH CHECK (bucket_id = 'lampiran-cuti');
CREATE POLICY "Allow authenticated users to update their own attachments" ON storage.objects FOR UPDATE TO authenticated USING (auth.uid() = owner) WITH CHECK (bucket_id = 'lampiran-cuti');
CREATE POLICY "Allow authenticated users to delete their own attachments" ON storage.objects FOR DELETE TO authenticated USING (auth.uid() = owner);

